{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    .spreadsheet {
        overflow: auto;
        height: 80vh;
        border: 1px solid #ddd;
    }
    
    .cell {
        min-width: 120px;
        height: 30px;
        border: 1px solid #eee;
        padding: 2px;
        white-space: nowrap;
    }
    
    .cell:focus {
        outline: 2px solid #4d90fe;
        z-index: 1;
    }
    
    .header-row {
        background: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    
    .header-col {
        background: #f8f9fa;
        position: sticky;
        left: 0;
        z-index: 1;
    }
    
    .formula-bar {
        height: 40px;
        border-bottom: 1px solid #ddd;
    }
</style>
<div class="container-fluid p-3">
    <div class="formula-bar mb-2 d-flex align-items-center">
        <span class="me-2">Formula:</span>
        <input type="text" id="formulaInput" class="form-control">
    </div>
    
    <div class="spreadsheet" id="spreadsheet">
        <!-- Columns and rows will be generated by JavaScript -->
    </div>
    
    <div class="mt-3">
        <button class="btn btn-primary btn-sm" onclick="addRow()">Qator Qo'shish</button>
        <button class="btn btn-primary btn-sm" onclick="addColumn()">Ustun qo'shish</button>
        <button class="btn btn-danger btn-sm" onclick="clearData()">Hammasini tozalash</button>
    </div>
</div>

<script>
const ROWS = 20;
const COLS = 10;
let currentCell = null;
let spreadsheetData = {};

function createSpreadsheet() {
const spreadsheet = document.getElementById('spreadsheet');
const table = document.createElement('table');

// Create header row
const headerRow = document.createElement('tr');
headerRow.className = 'header-row';
headerRow.appendChild(createCell('', 'header-col'));
for(let col = 0; col < COLS; col++) {
    headerRow.appendChild(createCell(String.fromCharCode(65 + col)));
}
table.appendChild(headerRow);

// Create data rows
for(let row = 1; row <= ROWS; row++) {
    const tr = document.createElement('tr');
    tr.appendChild(createCell(row, 'header-col'));
    
    for(let col = 0; col < COLS; col++) {
        const cellId = `${String.fromCharCode(65 + col)}${row}`;
        const cell = createCell('', 'cell');
        cell.contentEditable = true;
        cell.id = cellId;
        
        cell.addEventListener('focus', () => handleCellFocus(cellId));
        cell.addEventListener('input', () => handleCellInput(cellId));
        
        tr.appendChild(cell);
    }
    table.appendChild(tr);
}

spreadsheet.appendChild(table);
}

function createCell(content, className = '') {
const td = document.createElement('td');
td.className = className + ' cell';
td.textContent = content;
return td;
}

function handleCellFocus(cellId) {
currentCell = cellId;
document.getElementById('formulaInput').value = spreadsheetData[cellId]?.formula || '';
}

function handleCellInput(cellId) {
const cell = document.getElementById(cellId);
const value = cell.textContent.trim();

if(value.startsWith('=')) {
    // Simple formula handling
    try {
        const formula = value.slice(1);
        const result = evaluateFormula(formula);
        cell.textContent = result;
        spreadsheetData[cellId] = { value: result, formula: value };
    } catch {
        cell.textContent = '#ERROR';
        spreadsheetData[cellId] = { value: '#ERROR', formula: value };
    }
} else {
    spreadsheetData[cellId] = { value: value, formula: '' };
}
}

function evaluateFormula(formula) {
// Simple SUM function implementation
if(formula.toUpperCase().startsWith('SUM(')) {
    const range = formula.match(/\((.*?)\)/)[1].split(':');
    const [start, end] = range;
    return sumRange(start, end);
}
return eval(formula); // Simple evaluation (not safe for production)
}

function sumRange(start, end) {
const [startCol, startRow] = parseCellId(start);
const [endCol, endRow] = parseCellId(end);
let sum = 0;

for(let row = startRow; row <= endRow; row++) {
    for(let col = startCol; col <= endCol; col++) {
        const cellId = `${String.fromCharCode(65 + col)}${row}`;
        sum += parseFloat(spreadsheetData[cellId]?.value) || 0;
    }
}
return sum;
}

function parseCellId(cellId) {
const col = cellId.match(/[A-Z]+/)[0];
const row = cellId.match(/\d+/)[0];
return [col.charCodeAt(0) - 65, parseInt(row)];
}

function addRow() {
// Implementation for adding new rows
}

function addColumn() {
// Implementation for adding new columns
}

function clearData() {
spreadsheetData = {};
document.querySelectorAll('.cell[contenteditable]').forEach(cell => {
    cell.textContent = '';
});
}

// Initialize spreadsheet
createSpreadsheet();
</script>
{% endblock %}